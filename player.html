<!DOCTYPE html>
<html lang="en">
<head>
    <title>Watch Now - Unruly Movies | Luganda VJ Translations</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Watch Luganda translated movies on Unruly Movies - A legitimate Ugandan entertainment platform developed by Nduga Hafizu featuring licensed VJs.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#66BB6A">
    <meta name="author" content="Nduga Hafizu">
    <meta name="robots" content="noindex">
    <meta name="google-adsense-account" content="ca-pub-1904736753681797">
    
    <!-- DNS Prefetch and Preconnect for faster video loading -->
    <link rel="dns-prefetch" href="//archive.org">
    <link rel="dns-prefetch" href="//streamtape.com">
    <link rel="dns-prefetch" href="//ia601502.us.archive.org">
    <link rel="dns-prefetch" href="//ia902802.us.archive.org">
    <link rel="preconnect" href="https://archive.org" crossorigin>
    <link rel="preconnect" href="https://luganda-translated-movies-production.up.railway.app" crossorigin>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HMF82HVT9G"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-HMF82HVT9G');
    </script>
    
    <!-- Open Graph / Social Share Meta -->
    <meta property="og:type" content="video.movie">
    <meta property="og:site_name" content="Unruly Movies">
    <meta property="og:title" content="Watch Now - Unruly Movies">
    <meta property="og:description" content="Watch Luganda translated movies on Unruly Movies - Legitimate Ugandan platform by Nduga Hafizu">
    <meta property="og:image" content="">
    <meta property="og:url" content="">
    
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon.png">
    <link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png">
    <link rel="apple-touch-icon" href="/assets/images/logo.png">
    <link rel="apple-touch-icon" href="assets/images/icons/icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Plyr CSS - Legal open-source player -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
    
    <!-- Main Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/trailer-player.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1904736753681797" crossorigin="anonymous"></script>
    
    <style>
        /* Player Page Responsive Styles */
        :root {
            --player-radius: 12px;
            --primary-color: #7CFC00;
            --background-dark: #0a0a0a;
            --background-light: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --border-color: #333333;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background-dark);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        /* Header */
        .player-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.3s ease;
        }
        
        .player-header.hidden {
            transform: translateY(-100%);
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .back-btn:hover {
            background: rgba(124, 252, 0, 0.2);
            color: var(--primary-color);
        }
        
        .header-logo {
            height: 35px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .header-btn:hover {
            background: var(--primary-color);
            color: #000;
        }
        
        /* Main Player Container */
        .player-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: #000;
            padding-top: 60px;
        }
        
        @media (max-width: 768px) {
            .preroll-container {
                padding: 15px;
            }
            
            .preroll-ad-content {
                padding: 20px;
                min-height: 250px;
            }
            
            .preroll-header {
                flex-wrap: wrap;
                gap: 10px;
            }
        }
        
        /* Plyr Customization */
        .plyr {
            --plyr-color-main: #7CFC00;
            --plyr-video-background: #000;
            --plyr-menu-background: rgba(26, 26, 26, 0.95);
            --plyr-menu-color: #fff;
            --plyr-menu-border-color: #333;
        }
        
        /* Embed Container Styles */
        #embedContainer {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--player-radius);
            overflow: hidden;
        }
        
        #embedContainer iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Hide Archive.org branding, account links and share button in embed */
        #embedContainer {
            position: relative;
            overflow: hidden;
        }
        
        /* Full top overlay bar - completely covers Archive.org header */
        .embed-top-cover {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: #000;
            z-index: 100;
            pointer-events: auto; /* Block clicks on Archive.org buttons */
        }
        
        /* Right side cover - hides share button and all right-side controls */
        .embed-right-cover {
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 80px;
            background: #000;
            z-index: 101;
            pointer-events: auto;
        }
        
        /* Left side cover - hides Archive.org logo/account link */
        .embed-left-cover {
            position: absolute;
            top: 0;
            left: 0;
            width: 350px;
            height: 70px;
            background: #000;
            z-index: 101;
            pointer-events: auto;
        }
        
        /* Custom branding bar for embed player */
        .embed-brand-bar {
            position: absolute;
            top: 12px;
            left: 15px;
            z-index: 25;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 8px;
            border: 1px solid var(--primary-color);
            pointer-events: none;
        }
        
        .embed-brand-bar img {
            height: 24px;
            width: auto;
        }
        
        .embed-brand-bar span {
            color: var(--primary-color);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        /* Gradient fade below the top cover for smooth transition */
        .embed-top-cover::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to bottom, #000 0%, transparent 100%);
            pointer-events: none;
        }
        
        @media (max-width: 767px) {
            #embedContainer {
                border-radius: 0;
            }
            
            .embed-top-cover {
                height: 60px;
            }
            
            .embed-left-cover {
                width: 200px;
                height: 60px;
            }
            
            .embed-right-cover {
                width: 150px;
                height: 65px;
            }
            
            .embed-brand-bar {
                top: 15px;
                left: 10px;
                padding: 5px 10px;
            }
            
            .embed-brand-bar img {
                height: 18px;
            }
            
            .embed-brand-bar span {
                font-size: 10px;
            }
        }
        
        .plyr--full-ui input[type=range] {
            color: var(--plyr-color-main);
        }
        
        .plyr__control--overlaid {
            background: rgba(124, 252, 0, 0.9);
            color: #000;
        }
        
        .plyr__control--overlaid:hover {
            background: #7CFC00;
        }
        
        .plyr__controls {
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 20px 15px 15px;
        }
        
        /* Content Section */
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Movie Info Card */
        .movie-info-card {
            background: var(--background-light);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .movie-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .movie-poster-small {
            width: 120px;
            height: 180px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
            display: none;
        }
        
        .movie-details {
            flex: 1;
            min-width: 0;
        }
        
        .movie-title {
            font-size: clamp(20px, 5vw, 32px);
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.2;
        }
        
        .movie-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .meta-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .meta-badge.quality {
            background: var(--primary-color);
            color: #000;
            font-weight: 600;
        }
        
        .meta-badge.rating {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
        }
        
        .meta-badge svg {
            width: 14px;
            height: 14px;
        }
        
        .vj-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(124, 252, 0, 0.1);
            border: 1px solid rgba(124, 252, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .vj-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }
        
        .vj-details {
            flex: 1;
        }
        
        .vj-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .vj-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .movie-description {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .movie-description.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .show-more-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 13px;
            padding: 0;
            margin-bottom: 15px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
        }
        
        .action-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: #000;
        }
        
        .btn-primary:hover {
            background: #9dff44;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(124, 252, 0, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--primary-color);
        }
        
        .btn-trailer {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: #fff;
            font-weight: 700;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-trailer:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
        }
        
        .btn-trailer:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Like button liked state */
        #likeBtn.liked {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: #fff;
            border-color: transparent;
        }
        
        #likeBtn.liked svg {
            fill: currentColor;
        }
        
        #likeBtn {
            transition: transform 0.15s ease, background 0.3s ease;
        }
        
        /* Quality Selector Dropdown */
        .quality-selector {
            position: relative;
        }
        
        .quality-btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quality-dropdown {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--background-light);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .quality-selector.open .quality-dropdown {
            opacity: 1;
            visibility: visible;
        }
        
        .quality-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quality-option:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .quality-option.active {
            background: rgba(124, 252, 0, 0.1);
            color: var(--primary-color);
        }
        
        .quality-option.active::before {
            content: 'âœ“';
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .quality-label {
            font-size: 11px;
            padding: 3px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            color: var(--text-secondary);
        }
        
        .quality-option.active .quality-label {
            background: rgba(124, 252, 0, 0.2);
            color: var(--primary-color);
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
        }
        
        /* Episodes Section */
        .episodes-section {
            background: var(--background-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .season-select {
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        
        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .episode-card {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .episode-card:hover,
        .episode-card.active {
            border-color: var(--primary-color);
            background: rgba(124, 252, 0, 0.05);
        }
        
        .episode-thumb {
            width: 120px;
            height: 70px;
            border-radius: 8px;
            background: #333;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .episode-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .episode-play-icon {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .episode-card:hover .episode-play-icon {
            opacity: 1;
        }
        
        .episode-info {
            flex: 1;
            min-width: 0;
        }
        
        .episode-number {
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .episode-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .episode-duration {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Related Content */
        .related-section {
            margin-bottom: 30px;
        }
        
        .related-section .section-title {
            margin-bottom: 20px;
        }
        
        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .movie-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--background-light);
            transition: transform 0.3s ease;
            text-decoration: none;
            color: inherit;
        }
        
        .movie-card:hover {
            transform: translateY(-5px);
        }
        
        .movie-card-poster {
            position: relative;
            aspect-ratio: 2/3;
            overflow: hidden;
        }
        
        .movie-card-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .movie-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent 50%);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .movie-card:hover .movie-card-overlay {
            opacity: 1;
        }
        
        .play-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
        }
        
        .movie-card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 8px;
            background: var(--primary-color);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            border-radius: 4px;
        }
        
        .movie-card-info {
            padding: 12px;
        }
        
        .movie-card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .movie-card-vj {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Comments Section */
        .comments-section {
            background: var(--background-light);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .comments-section .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .comments-section .section-title {
            display: flex;
            align-items: center;
        }
        
        .comment-count {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
        }
        
        /* Add Comment Form */
        .add-comment-form {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .comment-user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .comment-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .comment-input-wrapper {
            flex: 1;
        }
        
        .comment-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px;
            font-size: 14px;
            color: #fff;
            resize: none;
            min-height: 50px;
            transition: all 0.3s ease;
        }
        
        .comment-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255,255,255,0.08);
        }
        
        .comment-actions {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .rating-input {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .star-rating-input {
            display: flex;
            flex-direction: row-reverse;
            gap: 2px;
        }
        
        .star-rating-input input {
            display: none;
        }
        
        .star-rating-input label {
            cursor: pointer;
            font-size: 22px;
            color: #444;
            transition: all 0.2s ease;
        }
        
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label,
        .star-rating-input input:checked ~ label {
            color: #FFD700;
        }
        
        .comment-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-cancel:hover {
            border-color: rgba(255,255,255,0.4);
            color: #fff;
        }
        
        .btn-submit {
            padding: 10px 20px;
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-submit:hover {
            background: #5cb85c;
            transform: translateY(-2px);
        }
        
        /* Comments List */
        .comments-list {
            min-height: 100px;
        }
        
        .comments-loading,
        .no-comments {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .no-comments svg {
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .comment-item {
            display: flex;
            gap: 15px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .comment-content {
            flex: 1;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .comment-author {
            font-weight: 600;
            font-size: 14px;
        }
        
        .admin-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        
        .admin-badge svg {
            width: 12px;
            height: 12px;
        }
        
        .comment-rating {
            display: flex;
            gap: 2px;
        }
        
        .comment-rating .star {
            font-size: 12px;
            color: #FFD700;
        }
        
        .comment-date {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .comment-text {
            font-size: 14px;
            line-height: 1.6;
            color: rgba(255,255,255,0.85);
            margin-bottom: 10px;
        }
        
        .comment-actions-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .comment-action-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            padding: 5px 0;
            transition: color 0.3s ease;
        }
        
        .comment-action-btn:hover {
            color: var(--primary-color);
        }
        
        .comment-action-btn.liked {
            color: #FF6B6B;
        }
        
        .load-more-comments {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .load-more-comments:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* Footer */
        .player-footer {
            background: var(--background-light);
            padding: 30px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Loading State */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(124, 252, 0, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error State */
        .error-state {
            position: absolute;
            inset: 0;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        .error-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .error-message {
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        /* ===============================
           RESPONSIVE BREAKPOINTS
           =============================== */
        
        /* Large Desktop */
        @media (min-width: 1400px) {
            .content-wrapper {
                max-width: 1600px;
            }
            
            .related-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
        
        /* Desktop */
        @media (min-width: 992px) {
            .movie-poster-small {
                display: block;
            }
            
            .player-wrapper {
                max-width: calc(100% - 40px);
                margin: 0 auto;
                padding-top: 80px;
            }
            
            .plyr {
                border-radius: var(--player-radius);
            }
            
            .action-btn:not(.btn-icon) {
                padding: 14px 24px;
            }
        }
        
        /* Tablet */
        @media (min-width: 768px) and (max-width: 991px) {
            .player-wrapper {
                padding-top: 70px;
            }
            
            .movie-header {
                flex-direction: row;
            }
            
            .movie-poster-small {
                display: block;
                width: 100px;
                height: 150px;
            }
            
            .episodes-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .related-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Mobile Landscape */
        @media (max-width: 767px) and (orientation: landscape) {
            .player-wrapper {
                height: 100vh;
                padding-top: 0;
            }
            
            .player-header {
                padding: 10px 15px;
                background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            }
            
            .content-wrapper {
                display: none;
            }
            
            .player-footer {
                display: none;
            }
        }
        
        /* Mobile Portrait */
        @media (max-width: 767px) {
            .player-header {
                padding: 10px 15px;
            }
            
            .back-btn span {
                display: none;
            }
            
            .back-btn {
                padding: 10px;
            }
            
            .header-logo {
                height: 28px;
            }
            
            .player-wrapper {
                padding-top: 55px;
            }
            
            .plyr {
                border-radius: 0;
            }
            
            .content-wrapper {
                padding: 15px;
            }
            
            .movie-info-card {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .movie-header {
                flex-direction: column;
            }
            
            .movie-title {
                font-size: 22px;
            }
            
            .meta-badge {
                padding: 5px 10px;
                font-size: 12px;
            }
            
            .vj-info {
                padding: 10px 12px;
            }
            
            .vj-avatar {
                width: 40px;
                height: 40px;
            }
            
            .action-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .action-btn {
                padding: 12px 15px;
                font-size: 13px;
                justify-content: center;
            }
            
            .action-btn.btn-full {
                grid-column: 1 / -1;
            }
            
            .episodes-section {
                padding: 15px;
                border-radius: 12px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .episodes-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .episode-card {
                padding: 12px;
            }
            
            .episode-thumb {
                width: 100px;
                height: 60px;
            }
            
            .related-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .movie-card-info {
                padding: 10px;
            }
            
            .movie-card-title {
                font-size: 13px;
            }
        }
        
        /* Small Mobile */
        @media (max-width: 374px) {
            .movie-title {
                font-size: 20px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .related-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .movie-card:hover {
                transform: none;
            }
            
            .movie-card:active {
                transform: scale(0.98);
            }
            
            .movie-card-overlay {
                opacity: 1;
                background: linear-gradient(to top, rgba(0,0,0,0.7), transparent 70%);
            }
            
            .play-circle {
                width: 40px;
                height: 40px;
            }
            
            .episode-play-icon {
                opacity: 1;
            }
        }
        
        /* Safe Area for notched devices */
        @supports (padding: max(0px)) {
            .player-header {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
            }
            
            .content-wrapper {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="player-header" id="playerHeader">
        <a href="index.html" class="back-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            <span>Back</span>
        </a>
        
        <a href="index.html">
            <img src="assets/images/logo.png" alt="Unruly Movies" class="header-logo">
        </a>
        
        <div class="header-actions">
            <button class="header-btn share-btn" aria-label="Share">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
            </button>
        </div>
    </header>

    <!-- Video Player -->
    <div class="player-wrapper" id="playerWrapper">
        <!-- Native Video Player (for direct video files) -->
        <video id="player" playsinline controls crossorigin style="display: none;">
            <source src="" type="video/mp4">
        </video>
        
        <!-- Embed Player Container (for Streamtape, Archive.org, etc.) -->
        <div id="embedContainer" style="display: none; width: 100%; min-height: 400px; aspect-ratio: 16/9; background: #000; position: relative;">
            <!-- Top cover bar - completely hides Archive.org header -->
            <div class="embed-top-cover"></div>
            <!-- Left cover - hides Archive.org logo and account link -->
            <div class="embed-left-cover"></div>
            <!-- Right cover - hides share button -->
            <div class="embed-right-cover"></div>
            <!-- Unruly Movies branding -->
            <div class="embed-brand-bar">
                <img src="assets/images/logo.png" alt="Unruly Movies">
                <span>UNRULY MOVIES</span>
            </div>
            <iframe 
                id="embedPlayer" 
                src="" 
                frameborder="0" 
                allowfullscreen
                webkitallowfullscreen="true"
                mozallowfullscreen="true"
                loading="eager"
                allow="autoplay; fullscreen; encrypted-media; picture-in-picture; accelerometer; gyroscope"
                style="width: 100%; height: 100%; border: none;">
            </iframe>
        </div>
        
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="content-wrapper">
        <!-- Ad Banner Below Player -->
        <div class="ad-container" style="margin: 20px 0; text-align: center;">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-1904736753681797"
                 data-ad-slot="auto"
                 data-ad-format="rectangle"
                 data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <!-- Movie Info -->
        <div class="movie-info-card">
            <div class="movie-header">
                <img src="" alt="" class="movie-poster-small" id="moviePoster">
                <div class="movie-details">
                    <h1 class="movie-title" id="movieTitle">Loading...</h1>
                    
                    <div class="movie-meta" id="movieMeta">
                        <span class="meta-badge quality" id="movieQuality">HD</span>
                        <span class="meta-badge rating" id="movieRating">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            <span>8.5</span>
                        </span>
                        <span class="meta-badge" id="movieYear">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span>2024</span>
                        </span>
                        <span class="meta-badge" id="movieDuration">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span>2h 15m</span>
                        </span>
                    </div>
                    
                    <div class="vj-info" id="vjInfo">
                        <img src="assets/images/default-avatar.svg" alt="VJ" class="vj-avatar" id="vjAvatar">
                        <div class="vj-details">
                            <div class="vj-label">Translated by</div>
                            <div class="vj-name" id="vjName">VJ Junior</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="movie-description collapsed" id="movieDescription">
                Loading description...
            </p>
            <button class="show-more-btn" id="showMoreBtn">Show more</button>
            
            <div class="action-buttons">
                <button class="action-btn btn-trailer" id="trailerBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Watch Trailer
                </button>
                
                <!-- Quality Selector -->
                <div class="quality-selector" id="qualitySelector">
                    <button class="action-btn btn-secondary quality-btn" id="qualityBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        <span id="currentQuality">Auto</span>
                    </button>
                    <div class="quality-dropdown" id="qualityDropdown">
                        <div class="quality-option" data-quality="auto">
                            <span>Auto</span>
                            <span class="quality-label">Recommended</span>
                        </div>
                        <div class="quality-option" data-quality="1080p">
                            <span>1080p</span>
                            <span class="quality-label">HD</span>
                        </div>
                        <div class="quality-option" data-quality="720p">
                            <span>720p</span>
                            <span class="quality-label">HD</span>
                        </div>
                        <div class="quality-option" data-quality="480p">
                            <span>480p</span>
                            <span class="quality-label">SD</span>
                        </div>
                        <div class="quality-option" data-quality="360p">
                            <span>360p</span>
                            <span class="quality-label">Low</span>
                        </div>
                    </div>
                </div>
                
                <button class="action-btn btn-primary btn-full" id="watchlistBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Add to Watchlist
                </button>
                <button class="action-btn btn-secondary" id="likeBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    Like
                </button>
                <button class="action-btn btn-secondary share-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                </button>
                <button class="action-btn btn-secondary btn-icon" id="downloadBtn" title="Download">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Episodes Section (for TV Series) -->
        <div class="episodes-section" id="episodesSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Episodes</h2>
                <select class="season-select" id="seasonSelect">
                    <option value="1">Season 1</option>
                </select>
            </div>
            <div class="episodes-grid" id="episodesGrid">
                <!-- Episodes will be generated here -->
            </div>
        </div>

        <!-- Comments & Reviews Section -->
        <section class="comments-section" id="commentsSection">
            <div class="section-header">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px; vertical-align: middle;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Comments & Reviews
                </h2>
                <div class="comment-count" id="commentCount">0 comments</div>
            </div>
            
            <!-- Add Comment Form -->
            <div class="add-comment-form" id="addCommentForm">
                <div class="comment-user-avatar" id="commentUserAvatar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="comment-input-wrapper">
                    <textarea class="comment-input" id="commentInput" placeholder="Write a comment..." rows="1"></textarea>
                    <div class="comment-actions" id="commentActions" style="display: none;">
                        <div class="rating-input">
                            <span>Rate this movie:</span>
                            <div class="star-rating-input" id="movieRatingInput">
                                <input type="radio" name="rating" id="star5" value="5"><label for="star5">â˜…</label>
                                <input type="radio" name="rating" id="star4" value="4"><label for="star4">â˜…</label>
                                <input type="radio" name="rating" id="star3" value="3"><label for="star3">â˜…</label>
                                <input type="radio" name="rating" id="star2" value="2"><label for="star2">â˜…</label>
                                <input type="radio" name="rating" id="star1" value="1"><label for="star1">â˜…</label>
                            </div>
                        </div>
                        <div class="comment-buttons">
                            <button class="btn-cancel" id="cancelComment">Cancel</button>
                            <button class="btn-submit" id="submitComment">Post Comment</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Comments List -->
            <div class="comments-list" id="commentsList">
                <div class="comments-loading" id="commentsLoading">
                    <div class="spinner"></div>
                    <p>Loading comments...</p>
                </div>
                <div class="no-comments" id="noComments" style="display: none;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>No comments yet. Be the first to share your thoughts!</p>
                </div>
                <!-- Comments will be loaded here -->
            </div>
            
            <!-- Load More Comments -->
            <button class="load-more-comments" id="loadMoreComments" style="display: none;">
                Load More Comments
            </button>
        </section>

        <!-- Related Content -->
        <section class="related-section">
            <h2 class="section-title">You May Also Like</h2>
            
            <!-- Ad Banner in Related Section -->
            <div class="ad-container" style="margin: 15px 0; text-align: center;">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-1904736753681797"
                     data-ad-slot="auto"
                     data-ad-format="fluid"
                     data-ad-layout-key="-fb+5w+4e-db+86"></ins>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
            
            <div class="related-grid" id="relatedGrid">
                <!-- Related movies will be loaded here -->
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="player-footer">
        <p>Copyright Â© unruly movies watch 2026</p>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/tmdb-api.js"></script>
    <script src="js/trailer-player.js"></script>
    <script src="js/social-share.js"></script>
    <script src="js/watchlist-manager.js"></script>
    <script src="js/notifications.js"></script>
    
    <script>
        // Initialize Plyr
        const video = document.getElementById('player');
        const embedContainer = document.getElementById('embedContainer');
        const embedPlayer = document.getElementById('embedPlayer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        let player = null;
        let isEmbedMode = false;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');
        const streamUrl = urlParams.get('stream');
        const embedUrl = urlParams.get('embed');
        const isSeries = urlParams.has('series');
        const isStation = urlParams.has('station');

        // Comments system variables (declared early to avoid temporal dead zone)
        let commentsPage = 1;
        const commentsPerPage = 10;
        let allComments = [];

        // Check if URL is a direct video file (can be played natively)
        function isDirectVideoUrl(url) {
            if (!url) return false;
            
            // Archive.org EMBED URLs should use iframe (better compatibility)
            if (url.includes('archive.org/embed/')) return false;
            
            // Archive.org direct downloads (only MP4/WebM for native playback)
            if (url.includes('archive.org/download/')) {
                const urlLower = url.toLowerCase();
                // Only treat MP4 and WebM as direct (they work in all browsers)
                if (urlLower.endsWith('.mp4') || urlLower.endsWith('.webm')) return true;
                // MKV should use embed player for better compatibility
                if (urlLower.endsWith('.mkv')) return false;
            }
            
            // Direct video file extensions (browser-compatible only)
            const videoExtensions = ['.mp4', '.webm', '.m4v', '.m3u8'];
            const urlLower = url.toLowerCase();
            if (videoExtensions.some(ext => urlLower.includes(ext))) return true;
            
            // Google Drive direct links
            if (url.includes('drive.google.com') && url.includes('export=download')) return true;
            
            // Cloudflare R2 public URLs
            if (url.includes('.r2.dev/')) return true;
            
            // Backblaze B2 URLs
            if (url.includes('backblazeb2.com')) return true;
            
            return false;
        }
        
        // Check if URL is an Archive.org embed/item URL
        function isArchiveOrgUrl(url) {
            if (!url) {
                console.log('ðŸ” isArchiveOrgUrl: URL is empty/null');
                return false;
            }
            const isArchive = url.includes('archive.org/embed/') || 
                   url.includes('archive.org/details/') ||
                   (url.includes('archive.org/download/') && url.toLowerCase().endsWith('.mkv'));
            console.log('ðŸ” isArchiveOrgUrl check:', url.substring(0, 50), '... =', isArchive);
            return isArchive;
        }
        
        // Convert Archive.org URL to embed URL with minimal UI
        function getArchiveOrgEmbedUrl(url) {
            if (!url) return null;
            
            let embedUrl = url;
            
            // Already an embed URL
            if (url.includes('archive.org/embed/')) {
                embedUrl = url;
            }
            // Convert details URL to embed
            else if (url.includes('archive.org/details/')) {
                embedUrl = url.replace('/details/', '/embed/');
            }
            // Convert download URL to embed (extract item ID)
            else if (url.includes('archive.org/download/')) {
                const match = url.match(/archive\.org\/download\/([^\/]+)/);
                if (match) {
                    embedUrl = `https://archive.org/embed/${match[1]}`;
                }
            }
            
            // Add parameters to hide Archive.org branding and account links
            // ui=min - minimal UI, playlist=0 - no playlist, autoplay=1
            const separator = embedUrl.includes('?') ? '&' : '?';
            embedUrl += `${separator}ui=min&playlist=0&autoplay=1&output=embed`;
            
            return embedUrl;
        }

        // Initialize Plyr only for native video
        function initPlyr() {
            if (player) return player;
            
            player = new Plyr(video, {
                controls: [
                    'play-large',
                    'rewind',
                    'play',
                    'fast-forward',
                    'progress',
                    'current-time',
                    'duration',
                    'mute',
                    'volume',
                    'captions',
                    'settings',
                    'pip',
                    'airplay',
                    'fullscreen'
                ],
                settings: ['captions', 'quality', 'speed'],
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                keyboard: { focused: true, global: true },
                tooltips: { controls: true, seek: true },
                seekTime: 10,
                invertTime: false,
                toggleInvert: true,
                displayDuration: true,
                ratio: '16:9'
            });
            
            return player;
        }

        // Load movie data
        async function loadMovieData() {
            try {
                if (movieId) {
                    console.log('ðŸŽ¬ Loading movie data for ID:', movieId);
                    
                    const apiUrl = typeof API_CONFIG !== 'undefined' 
                        ? API_CONFIG.BASE_URL 
                        : 'https://luganda-translated-movies-production.up.railway.app';
                    
                    console.log('ðŸ“¡ API URL:', `${apiUrl}/api/luganda-movies/${movieId}`);
                    
                    const response = await fetch(`${apiUrl}/api/luganda-movies/${movieId}`);
                    const data = await response.json();
                    
                    console.log('ðŸ“¦ API Response:', data);
                    
                    if ((data.status === 'success' || data.success === true) && data.data) {
                        const movie = data.data;
                        console.log('ðŸŽ¥ Movie data:', movie);
                        updateMovieInfo(movie);
                        
                        // Get embed URL from either location
                        const videoUrl = movie.embedUrl || movie.video?.embedUrl || movie.video?.url;
                        const streamtapeId = movie.video?.streamtapeId;
                        
                        console.log('ðŸŽ¬ Video URL:', videoUrl);
                        
                        // Check if it's an Archive.org URL (use their embed player - works for MKV!)
                        if (videoUrl && isArchiveOrgUrl(videoUrl)) {
                            console.log('ðŸ“¦ Archive.org URL detected, using embed player');
                            const archiveEmbedUrl = getArchiveOrgEmbedUrl(videoUrl);
                            loadArchiveOrgEmbed(archiveEmbedUrl);
                        }
                        // Check if it's a direct playable URL (MP4, WebM only)
                        else if (videoUrl && isDirectVideoUrl(videoUrl)) {
                            console.log('âœ… Direct video URL detected, playing directly');
                            loadVideoSource(videoUrl);
                        }
                        // Check for embed URL (Streamtape, etc.)
                        else if (videoUrl || streamtapeId) {
                            const embedSrc = videoUrl || 
                                `https://streamtape.com/e/${streamtapeId}`;
                            loadEmbedVideo(embedSrc);
                        } else {
                            // Fall back to direct video URL
                            loadVideoSource(movie.video?.originalVideoPath || movie.streamUrl);
                        }
                        
                        loadRelatedMovies(movie.genres?.[0] || 'action');
                    } else {
                        console.error('âŒ API returned error or no data:', data);
                        document.getElementById('movieDescription').textContent = 'Unable to load movie description. Please try refreshing the page.';
                    }
                } else if (embedUrl) {
                    // Direct embed URL from query param
                    loadEmbedVideo(embedUrl);
                    document.getElementById('movieTitle').textContent = urlParams.get('title') || 'Now Playing';
                } else if (streamUrl) {
                    loadVideoSource(streamUrl);
                    document.getElementById('movieTitle').textContent = urlParams.get('movie') || urlParams.get('station') || 'Now Playing';
                    loadingOverlay.style.display = 'none';
                    // Hide trailer button for direct streams/TV
                    const trailerBtn = document.getElementById('trailerBtn');
                    if (trailerBtn) trailerBtn.style.display = 'none';
                } else {
                    // Demo video for testing
                    loadVideoSource('https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4');
                    document.getElementById('movieTitle').textContent = 'Demo Video - Big Buck Bunny';
                    document.getElementById('movieDescription').textContent = 'Big Buck Bunny is a short computer-animated comedy film featuring animals of the forest. This is a demo video to test the player functionality.';
                    loadingOverlay.style.display = 'none';
                }
            } catch (error) {
                console.error('âŒ Error loading movie:', error);
                document.getElementById('movieDescription').textContent = 'Error loading movie. Please check your connection and try again.';
                loadingOverlay.style.display = 'none';
                // Load demo video on error
                loadVideoSource('https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4');
                document.getElementById('movieTitle').textContent = 'Demo Video';
            }
        }

        // Load embed video (Streamtape, etc.) - Try ad-free extraction first
        async function loadEmbedVideo(url) {
            console.log('ðŸŽ¬ Loading video from:', url);
            
            // First, try to extract direct video URL (ad-free)
            try {
                const extractResponse = await fetch(`${API_BASE}/video/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                
                const extractData = await extractResponse.json();
                console.log('ðŸ“¦ Extraction result:', extractData);
                
                if (extractData.success && extractData.directUrl) {
                    console.log('âœ… Direct URL extracted! Playing ad-free.');
                    
                    // Use our own player with the direct URL
                    isEmbedMode = false;
                    embedContainer.style.display = 'none';
                    video.style.display = 'block';
                    
                    // Check if it's HLS or direct MP4
                    if (extractData.type === 'hls' || extractData.directUrl.includes('.m3u8')) {
                        loadHLSSource(extractData.directUrl);
                    } else {
                        // For direct URLs that might have CORS issues, use proxy
                        const proxyUrl = `${API_BASE}/video/proxy?url=${encodeURIComponent(extractData.directUrl)}`;
                        loadVideoSource(proxyUrl);
                    }
                    
                    loadingOverlay.style.display = 'none';
                    return;
                }
            } catch (error) {
                console.warn('âš ï¸ Direct extraction failed, falling back to iframe:', error.message);
            }
            
            // Fallback: Use iframe embed (has ads)
            console.log('ðŸ“º Using iframe embed (fallback)');
            isEmbedMode = true;
            
            // Hide native player, show embed container
            video.style.display = 'none';
            if (player) {
                player.destroy();
                player = null;
            }
            embedContainer.style.display = 'block';
            
            // Set the embed URL
            embedPlayer.src = url;
            
            // Hide loading when iframe loads
            embedPlayer.onload = () => {
                loadingOverlay.style.display = 'none';
            };
            
            // Fallback hide loading after timeout
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 3000);
        }

        // Load Archive.org embed (works for MKV and all formats, NO ADS!)
        function loadArchiveOrgEmbed(url) {
            console.log('ðŸ“¦ Loading Archive.org embed:', url);
            isEmbedMode = true;
            
            // Extract the original Archive.org URL for fallback
            let originalArchiveUrl = url;
            if (url.includes('/embed/')) {
                originalArchiveUrl = url.replace('/embed/', '/details/').split('?')[0];
            }
            
            // Hide native player, show embed container
            video.style.display = 'none';
            if (player) {
                player.destroy();
                player = null;
            }
            embedContainer.style.display = 'block';
            
            // Set the Archive.org embed URL
            embedPlayer.src = url;
            
            // Listen for iframe load
            embedPlayer.onload = () => {
                console.log('âœ… Archive.org iframe loaded');
                loadingOverlay.style.display = 'none';
                
                // Check for embedding error after a short delay
                setTimeout(() => {
                    checkForEmbedError(originalArchiveUrl);
                }, 1500);
            };
            
            // Also check for error on iframe error event
            embedPlayer.onerror = () => {
                console.log('âŒ Archive.org embed failed');
                showEmbedErrorFallback(originalArchiveUrl);
            };
            
            // Fallback hide loading after timeout
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 5000);
        }
        
        // Check if embed shows error (embedding disabled)
        function checkForEmbedError(originalUrl) {
            // We can't access iframe content due to cross-origin, so provide a manual option
            // Add a "Not working?" button below the player
            addEmbedFallbackButton(originalUrl);
        }
        
        // Add fallback button for embed issues - DISABLED
        function addEmbedFallbackButton(originalUrl) {
            // Button removed - users will use direct video player
            console.log('Embed fallback button disabled');
        }
        
        // Show embed error fallback UI
        function showEmbedErrorFallback(originalUrl) {
            loadingOverlay.style.display = 'none';
            embedContainer.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    min-height: 300px;
                    background: #0a0a0a;
                    padding: 40px 20px;
                    text-align: center;
                ">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="1.5" style="margin-bottom: 20px;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    <h3 style="color: #fff; font-size: 18px; margin-bottom: 10px;">Video Unavailable</h3>
                    <p style="color: #888; font-size: 14px; margin-bottom: 25px; max-width: 400px;">
                        This video is temporarily unavailable. Please try another movie or check back later.
                    </p>
                </div>
            `;
        }

        // Load HLS source
        function loadHLSSource(url) {
            if (Hls.isSupported()) {
                const hls = new Hls({
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    initPlayer();
                    loadingOverlay.style.display = 'none';
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        // Fallback to iframe on HLS error
                        loadEmbedFallback(url);
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                initPlayer();
                loadingOverlay.style.display = 'none';
            }
        }

        // Fallback to iframe embed
        function loadEmbedFallback(originalUrl) {
            console.log('ðŸ“º Falling back to iframe embed');
            isEmbedMode = true;
            video.style.display = 'none';
            embedContainer.style.display = 'block';
            embedPlayer.src = originalUrl;
            loadingOverlay.style.display = 'none';
        }

        // Convert Streamtape URL to embed URL
        function getStreamtapeEmbedUrl(url) {
            if (!url) return null;
            
            // If already an embed URL, return as is
            if (url.includes('/e/')) return url;
            
            // Extract video ID from various Streamtape URL formats
            // https://streamtape.com/v/VIDEOID/title
            // https://streamtape.to/v/VIDEOID/title
            const match = url.match(/streamtape\.(com|to|net)\/v\/([a-zA-Z0-9]+)/);
            if (match) {
                return `https://streamtape.com/e/${match[2]}`;
            }
            
            return url;
        }

        // Update movie information on page
        function updateMovieInfo(movie) {
            document.getElementById('movieTitle').textContent = movie.originalTitle || movie.title;
            document.getElementById('movieDescription').textContent = movie.plot || movie.description || 'No description available.';
            
            const poster = document.getElementById('moviePoster');
            poster.src = movie.poster || 'assets/images/placeholder-poster.jpg';
            poster.alt = movie.originalTitle || movie.title;
            
            // Show pre-roll ad before video starts
            showPrerollAd(
                movie.originalTitle || movie.title,
                movie.poster || 'assets/images/placeholder-poster.jpg'
            );
            
            // Update meta tags for sharing
            document.querySelector('meta[property="og:title"]').content = movie.originalTitle || movie.title;
            document.querySelector('meta[property="og:description"]').content = movie.plot || movie.description || '';
            document.querySelector('meta[property="og:image"]').content = movie.poster || '';
            document.querySelector('meta[property="og:url"]').content = window.location.href;
            document.title = `${movie.originalTitle || movie.title} - Unruly Movies`;
            
            // Update badges
            if (movie.rating?.translationRating) {
                document.getElementById('movieRating').querySelector('span:last-child').textContent = movie.rating.translationRating.toFixed(1);
            }
            if (movie.releaseYear) {
                document.getElementById('movieYear').querySelector('span:last-child').textContent = movie.releaseYear;
            }
            if (movie.video?.quality) {
                document.getElementById('movieQuality').textContent = movie.video.quality.toUpperCase();
            }
            if (movie.video?.duration) {
                document.getElementById('movieDuration').querySelector('span:last-child').textContent = movie.video.duration;
            }
            
            // Update VJ info
            if (movie.vjName) {
                document.getElementById('vjName').textContent = `VJ ${movie.vjName}`;
            }
            if (movie.vjAvatar) {
                document.getElementById('vjAvatar').src = movie.vjAvatar;
            }
            
            // Setup trailer button if movie has TMDB ID (hide for TV stations)
            const trailerBtn = document.getElementById('trailerBtn');
            
            // Hide trailer button for TV stations
            if (isStation || isSeries) {
                if (trailerBtn) {
                    trailerBtn.style.display = 'none';
                }
            } else {
                // For movies, setup trailer functionality
                const tmdbId = movie.tmdbId || movie.metaData?.tmdbId || movie.externalIds?.tmdbId || movie.tmdb_id;
                console.log('ðŸŽ¬ Trailer setup - TMDB ID:', tmdbId, 'Movie data:', movie);
                
                if (trailerBtn) {
                    if (tmdbId) {
                        trailerBtn.style.display = 'flex';
                        trailerBtn.disabled = false;
                        trailerBtn.classList.remove('disabled');
                        trailerBtn.onclick = async () => {
                            console.log('ðŸŽ¬ Trailer button clicked, TMDB ID:', tmdbId);
                            trailerBtn.disabled = true;
                            trailerBtn.innerHTML = `
                                <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                                    <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"></circle>
                                </svg>
                                Loading...
                            `;
                            
                            try {
                                if (typeof trailerPlayer !== 'undefined' && trailerPlayer) {
                                    await trailerPlayer.playTrailer(tmdbId, movie.originalTitle || movie.title);
                                } else {
                                    throw new Error('TrailerPlayer not initialized');
                                }
                            } catch (error) {
                                console.error('Error playing trailer:', error);
                                showNotification('Trailer not available for this movie', 'error');
                            } finally {
                                trailerBtn.disabled = false;
                                trailerBtn.innerHTML = `
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    Watch Trailer
                                `;
                            }
                        };
                    } else {
                        trailerBtn.style.display = 'none';
                    }
                }
            }
            
            // Show episodes section for series
            if (movie.type === 'series' || isSeries) {
                loadEpisodes(movie);
            }
        }

        // Load video source
        function loadVideoSource(url) {
            if (!url) {
                loadingOverlay.style.display = 'none';
                return;
            }
            
            // Check if it's a Streamtape or other embed URL
            if (url.includes('streamtape.') || url.includes('doodstream.') || 
                url.includes('filemoon.') || url.includes('/e/') || url.includes('/embed/')) {
                const embedSrc = getStreamtapeEmbedUrl(url);
                loadEmbedVideo(embedSrc);
                return;
            }
            
            isEmbedMode = false;
            
            // Show native player, hide embed
            video.style.display = 'block';
            embedContainer.style.display = 'none';
            
            // Initialize Plyr
            initPlyr();
            
            // Check if HLS stream
            if (url.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        loadingOverlay.style.display = 'none';
                    });
                    
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            loadingOverlay.style.display = 'none';
                            console.error('HLS Error:', data);
                        }
                    });
                    
                    window.hlsPlayer = hls;
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                    video.addEventListener('loadedmetadata', () => {
                        loadingOverlay.style.display = 'none';
                    });
                }
            } else {
                // Regular video file (MP4, MKV, WebM, etc.)
                console.log('ðŸŽ¬ Loading video file:', url);
                
                video.src = url;
                video.addEventListener('loadedmetadata', () => {
                    console.log('âœ… Video loaded successfully');
                    loadingOverlay.style.display = 'none';
                });
                video.addEventListener('canplay', () => {
                    console.log('âœ… Video can play');
                    loadingOverlay.style.display = 'none';
                });
                video.addEventListener('error', (e) => {
                    loadingOverlay.style.display = 'none';
                    console.error('âŒ Video load error:', e);
                    
                    // Check if it's a format issue (MKV not supported in some browsers)
                    const urlLower = url.toLowerCase();
                    if (urlLower.includes('.mkv')) {
                        // Show helpful message for MKV files
                        showVideoError('MKV format may not be supported in this browser. Try using Chrome/Edge, or download the video to watch locally.', url);
                    } else {
                        showVideoError('Error loading video. The file may be unavailable or your browser may not support this format.', url);
                    }
                });
            }
        }
        
        // Show video error with download option
        function showVideoError(message, downloadUrl) {
            const videoContainer = document.querySelector('.video-wrapper');
            if (!videoContainer) return;
            
            // Create error overlay
            const errorDiv = document.createElement('div');
            errorDiv.className = 'video-error-overlay';
            errorDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; background: rgba(0,0,0,0.9); border-radius: 10px; max-width: 500px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2" style="margin-bottom: 20px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <h3 style="color: #fff; margin-bottom: 15px;">Video Playback Issue</h3>
                    <p style="color: #ccc; margin-bottom: 20px; line-height: 1.6;">${message}</p>
                    ${downloadUrl ? `
                        <a href="${downloadUrl}" download class="btn-admin" style="display: inline-flex; align-items: center; gap: 8px; text-decoration: none;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Download Video
                        </a>
                    ` : ''}
                </div>
            `;
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; z-index: 100;';
            
            videoContainer.style.position = 'relative';
            videoContainer.appendChild(errorDiv);
        }

        // Load episodes for series
        function loadEpisodes(movie) {
            const episodesSection = document.getElementById('episodesSection');
            const episodesGrid = document.getElementById('episodesGrid');
            
            episodesSection.style.display = 'block';
            episodesGrid.innerHTML = '';
            
            const episodes = movie.episodes || [];
            const numEpisodes = episodes.length || 10;
            
            for (let i = 0; i < numEpisodes; i++) {
                const ep = episodes[i] || {};
                const card = document.createElement('div');
                card.className = `episode-card ${i === 0 ? 'active' : ''}`;
                card.innerHTML = `
                    <div class="episode-thumb">
                        <img src="${ep.thumbnail || movie.poster || 'assets/images/placeholder-episode.jpg'}" alt="Episode ${i + 1}">
                        <div class="episode-play-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                    </div>
                    <div class="episode-info">
                        <div class="episode-number">Episode ${i + 1}</div>
                        <div class="episode-title">${ep.title || `Episode ${i + 1}`}</div>
                        <div class="episode-duration">${ep.duration || '45 min'}</div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    document.querySelectorAll('.episode-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    if (ep.url) {
                        loadVideoSource(ep.url);
                    }
                });
                
                episodesGrid.appendChild(card);
            }
        }

        // Load related movies
        async function loadRelatedMovies(genre) {
            const grid = document.getElementById('relatedGrid');
            
            try {
                const apiUrl = typeof API_CONFIG !== 'undefined' 
                    ? API_CONFIG.BASE_URL 
                    : 'https://luganda-translated-movies-production.up.railway.app';
                
                const response = await fetch(`${apiUrl}/api/luganda-movies/latest?limit=8`);
                const data = await response.json();
                
                if (data.status === 'success' && data.data) {
                    grid.innerHTML = data.data.map(movie => `
                        <a href="player.html?id=${movie._id}" class="movie-card">
                            <div class="movie-card-poster">
                                <img src="${movie.poster || 'assets/images/placeholder-poster.jpg'}" alt="${movie.originalTitle}" loading="lazy">
                                <div class="movie-card-overlay">
                                    <div class="play-circle">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                    </div>
                                </div>
                                <span class="movie-card-badge">${movie.video?.quality?.toUpperCase() || 'HD'}</span>
                            </div>
                            <div class="movie-card-info">
                                <div class="movie-card-title">${movie.originalTitle}</div>
                                <div class="movie-card-vj">VJ ${movie.vjName || 'Unknown'}</div>
                            </div>
                        </a>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading related movies:', error);
                grid.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">Unable to load recommendations</p>';
            }
        }

        // Show more / Show less description
        const showMoreBtn = document.getElementById('showMoreBtn');
        const description = document.getElementById('movieDescription');
        
        showMoreBtn.addEventListener('click', () => {
            description.classList.toggle('collapsed');
            showMoreBtn.textContent = description.classList.contains('collapsed') ? 'Show more' : 'Show less';
        });

        // Header hide on scroll
        let lastScroll = 0;
        const header = document.getElementById('playerHeader');
        
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            
            if (currentScroll > lastScroll && currentScroll > 100) {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
            }
            
            lastScroll = currentScroll;
        });

        // Watchlist button
        const watchlistBtn = document.getElementById('watchlistBtn');
        watchlistBtn.addEventListener('click', () => {
            if (typeof WatchlistManager !== 'undefined') {
                const movieData = {
                    id: movieId,
                    title: document.getElementById('movieTitle').textContent,
                    poster: document.getElementById('moviePoster').src
                };
                WatchlistManager.toggleWatchlist(movieData);
                
                const isInList = WatchlistManager.isInWatchlist(movieId);
                watchlistBtn.innerHTML = isInList ? `
                    <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    In Watchlist
                ` : `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Add to Watchlist
                `;
            }
        });

        // Like button functionality
        const likeBtn = document.getElementById('likeBtn');
        let isLiked = localStorage.getItem(`liked_${movieId}`) === 'true';
        
        // Update like button initial state
        function updateLikeButton() {
            likeBtn.innerHTML = isLiked ? `
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                Liked
            ` : `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                Like
            `;
            likeBtn.classList.toggle('liked', isLiked);
        }
        
        updateLikeButton();
        
        likeBtn.addEventListener('click', () => {
            isLiked = !isLiked;
            localStorage.setItem(`liked_${movieId}`, isLiked);
            updateLikeButton();
            
            // Visual feedback
            likeBtn.style.transform = 'scale(1.1)';
            setTimeout(() => {
                likeBtn.style.transform = 'scale(1)';
            }, 150);
        });

        // Wait for trailer player to be ready
        function waitForTrailerPlayer(callback, maxRetries = 10) {
            if (typeof trailerPlayer !== 'undefined' && trailerPlayer) {
                callback();
            } else if (maxRetries > 0) {
                setTimeout(() => waitForTrailerPlayer(callback, maxRetries - 1), 100);
            } else {
                console.warn('TrailerPlayer not available after retries');
                callback(); // Continue anyway
            }
        }

        // Initialize
        waitForTrailerPlayer(() => {
            console.log('âœ… TrailerPlayer ready, loading movie data...');
            loadMovieData();
        });
        
        // Load comments when movie is loaded
        if (movieId) {
            loadComments(movieId);
            setupCommentForm();
        }

        // ===================================
        // Quality Selector
        // ===================================
        
        let currentQuality = localStorage.getItem('preferredQuality') || 'auto';
        
        // Setup quality selector (must be after currentQuality declaration)
        setupQualitySelector();
        
        function setupQualitySelector() {
            const qualityBtn = document.getElementById('qualityBtn');
            const qualityDropdown = document.getElementById('qualityDropdown');
            const qualitySelector = document.getElementById('qualitySelector');
            const currentQualityEl = document.getElementById('currentQuality');
            
            if (!qualityBtn || !qualityDropdown) return;
            
            // Set initial quality display
            if (currentQualityEl) {
                currentQualityEl.textContent = currentQuality === 'auto' ? 'Auto' : currentQuality;
            }
            
            // Mark current quality as active
            const options = qualityDropdown.querySelectorAll('.quality-option');
            options.forEach(opt => {
                if (opt.dataset.quality === currentQuality) {
                    opt.classList.add('active');
                }
            });
            
            // Toggle dropdown
            qualityBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                qualitySelector.classList.toggle('open');
            });
            
            // Quality option click
            options.forEach(option => {
                option.addEventListener('click', () => {
                    const quality = option.dataset.quality;
                    
                    // Update UI
                    options.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    
                    if (currentQualityEl) {
                        currentQualityEl.textContent = quality === 'auto' ? 'Auto' : quality;
                    }
                    
                    // Save preference
                    currentQuality = quality;
                    localStorage.setItem('preferredQuality', quality);
                    
                    // Apply quality change
                    applyQuality(quality);
                    
                    // Close dropdown
                    qualitySelector.classList.remove('open');
                    
                    showNotification(`Quality set to ${quality === 'auto' ? 'Auto' : quality}`, 'success');
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!qualitySelector.contains(e.target)) {
                    qualitySelector.classList.remove('open');
                }
            });
        }
        
        function applyQuality(quality) {
            // Apply quality to HLS player if available
            if (typeof Hls !== 'undefined' && window.hlsInstance) {
                const hls = window.hlsInstance;
                
                if (quality === 'auto') {
                    hls.currentLevel = -1; // Auto
                } else {
                    // Find matching level
                    const targetHeight = parseInt(quality);
                    const levels = hls.levels || [];
                    
                    for (let i = 0; i < levels.length; i++) {
                        if (levels[i].height === targetHeight || levels[i].height <= targetHeight) {
                            hls.currentLevel = i;
                            break;
                        }
                    }
                }
            }
            
            // For Plyr player
            if (player && player.quality !== undefined) {
                if (quality !== 'auto') {
                    const qualityValue = parseInt(quality);
                    player.quality = qualityValue;
                }
            }
            
            console.log(`ðŸ“º Quality set to: ${quality}`);
        }

        // ===================================
        // Comments System
        // ===================================
        
        // Load comments from localStorage (or API when available)
        async function loadComments(movieId) {
            const loadingEl = document.getElementById('commentsLoading');
            const noCommentsEl = document.getElementById('noComments');
            const commentsListEl = document.getElementById('commentsList');
            const loadMoreBtn = document.getElementById('loadMoreComments');
            const commentCountEl = document.getElementById('commentCount');
            
            try {
                // Try to load from API first
                const apiUrl = typeof API_CONFIG !== 'undefined' 
                    ? API_CONFIG.BASE_URL 
                    : 'https://luganda-translated-movies-production.up.railway.app';
                
                try {
                    const response = await fetch(`${apiUrl}/api/comments/movie/${movieId}?page=${commentsPage}&limit=${commentsPerPage}`);
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.data?.comments) {
                        allComments = data.data.comments;
                        commentCountEl.textContent = `${data.data.pagination?.total || allComments.length} comments`;
                    }
                } catch (apiError) {
                    console.log('Comments API not available, using localStorage');
                    // Load from localStorage as fallback
                    const localComments = JSON.parse(localStorage.getItem(`comments_${movieId}`) || '[]');
                    allComments = localComments;
                    commentCountEl.textContent = `${allComments.length} comments`;
                }
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (allComments.length === 0) {
                    if (noCommentsEl) noCommentsEl.style.display = 'flex';
                    return;
                }
                
                if (noCommentsEl) noCommentsEl.style.display = 'none';
                renderComments(allComments);
                
            } catch (error) {
                console.error('Error loading comments:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (noCommentsEl) noCommentsEl.style.display = 'flex';
            }
        }
        
        // Render comments to the page
        function renderComments(comments) {
            const listEl = document.getElementById('commentsList');
            if (!listEl) return;
            
            // Clear loading and no comments elements
            const loadingEl = listEl.querySelector('.comments-loading');
            const noCommentsEl = listEl.querySelector('.no-comments');
            if (loadingEl) loadingEl.style.display = 'none';
            if (noCommentsEl) noCommentsEl.style.display = 'none';
            
            // Remove existing comments
            listEl.querySelectorAll('.comment-item').forEach(el => el.remove());
            
            comments.forEach(comment => {
                const commentEl = createCommentElement(comment);
                listEl.appendChild(commentEl);
            });
        }
        
        // Create a comment element
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment-item';
            div.dataset.id = comment.id || comment._id;
            
            const avatar = comment.user?.avatar || comment.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${comment.user?.name || comment.author || 'user'}`;
            const author = comment.user?.fullName || comment.user?.name || comment.author || 'Anonymous';
            const date = comment.createdAt ? formatTimeAgo(new Date(comment.createdAt)) : 'Just now';
            const rating = comment.rating || 0;
            const likes = comment.likeCount || comment.likes?.length || 0;
            const isLiked = comment.userLiked || localStorage.getItem(`comment_liked_${comment.id || comment._id}`) === 'true';
            const isAdmin = comment.user?.role === 'admin';
            
            // Admin badge HTML with crown icon
            const adminBadgeHtml = isAdmin ? `
                <span class="admin-badge">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/>
                    </svg>
                    Admin
                </span>
            ` : '';
            
            div.innerHTML = `
                <div class="comment-avatar">
                    <img src="${avatar}" alt="${author}">
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${author}</span>
                        ${adminBadgeHtml}
                        ${rating > 0 ? `
                        <div class="comment-rating">
                            ${Array(5).fill(0).map((_, i) => `<span class="star">${i < rating ? 'â˜…' : 'â˜†'}</span>`).join('')}
                        </div>
                        ` : ''}
                        <span class="comment-date">${date}</span>
                    </div>
                    <p class="comment-text">${escapeHtml(comment.content || comment.text)}</p>
                    <div class="comment-actions-row">
                        <button class="comment-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleCommentLike('${comment.id || comment._id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                            </svg>
                            <span>${likes}</span>
                        </button>
                        <button class="comment-action-btn" onclick="replyToComment('${comment.id || comment._id}', '${author}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            Reply
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // Setup comment form interactions
        function setupCommentForm() {
            const input = document.getElementById('commentInput');
            const actions = document.getElementById('commentActions');
            const cancelBtn = document.getElementById('cancelComment');
            const submitBtn = document.getElementById('submitComment');
            const avatarEl = document.getElementById('commentUserAvatar');
            
            console.log('ðŸ“ Setting up comment form:', { input, actions, cancelBtn, submitBtn });
            
            // Show actions when input is focused
            if (input) {
                input.addEventListener('focus', () => {
                    if (actions) actions.style.display = 'flex';
                    input.rows = 3;
                });
                
                // Auto-resize textarea
                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 150) + 'px';
                });
                
                // Submit on Ctrl+Enter
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        submitComment();
                    }
                });
            }
            
            // Cancel button
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    if (input) {
                        input.value = '';
                        input.rows = 1;
                        input.style.height = 'auto';
                    }
                    if (actions) actions.style.display = 'none';
                    // Clear rating
                    document.querySelectorAll('.star-rating-input input').forEach(r => r.checked = false);
                });
            }
            
            // Submit button
            if (submitBtn) {
                submitBtn.addEventListener('click', () => submitComment());
            }
            
            // Update avatar if user is logged in
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.picture && avatarEl) {
                avatarEl.innerHTML = `<img src="${user.picture}" alt="${user.name || 'User'}">`;
            }
        }
        
        // Submit a new comment
        async function submitComment() {
            console.log('ðŸ“ submitComment called');
            const input = document.getElementById('commentInput');
            const content = input?.value.trim();
            
            console.log('ðŸ“ Comment content:', content);
            
            if (!content) {
                showNotification('Please write a comment', 'error');
                return;
            }
            
            // Get selected rating
            const ratingInput = document.querySelector('.star-rating-input input:checked');
            const rating = ratingInput ? parseInt(ratingInput.value) : 0;
            console.log('ðŸ“ Rating:', rating);
            
            // Get user info
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            
            const newComment = {
                id: 'comment_' + Date.now(),
                movieId: movieId,
                author: user.name || 'Guest User',
                avatar: user.picture || null,
                content: content,
                rating: rating,
                createdAt: new Date().toISOString(),
                likes: [],
                likeCount: 0
            };
            
            try {
                // Try to save to API first
                if (token) {
                    const apiUrl = typeof API_CONFIG !== 'undefined' 
                        ? API_CONFIG.BASE_URL 
                        : 'https://luganda-translated-movies-production.up.railway.app';
                    
                    const response = await fetch(`${apiUrl}/api/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            movieId: movieId,
                            content: content,
                            rating: rating
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        newComment.id = data.data?.comment?._id || newComment.id;
                    }
                }
            } catch (error) {
                console.log('API not available, saving locally');
            }
            
            // Save to localStorage as backup
            const localComments = JSON.parse(localStorage.getItem(`comments_${movieId}`) || '[]');
            localComments.unshift(newComment);
            localStorage.setItem(`comments_${movieId}`, JSON.stringify(localComments));
            
            // Add to display
            allComments.unshift(newComment);
            
            // Hide no comments message
            const noCommentsEl = document.getElementById('noComments');
            if (noCommentsEl) noCommentsEl.style.display = 'none';
            
            // Render the new comment
            const listEl = document.getElementById('commentsList');
            const commentEl = createCommentElement(newComment);
            const firstComment = listEl.querySelector('.comment-item');
            if (firstComment) {
                listEl.insertBefore(commentEl, firstComment);
            } else {
                listEl.appendChild(commentEl);
            }
            
            // Update count
            const countEl = document.getElementById('commentCount');
            if (countEl) {
                countEl.textContent = `${allComments.length} comments`;
            }
            
            // Clear form
            input.value = '';
            input.rows = 1;
            input.style.height = 'auto';
            document.getElementById('commentActions').style.display = 'none';
            document.querySelectorAll('.star-rating-input input').forEach(r => r.checked = false);
            
            // Show success feedback
            showNotification('Comment posted successfully!', 'success');
        }
        
        // Toggle comment like
        function toggleCommentLike(commentId) {
            const isLiked = localStorage.getItem(`comment_liked_${commentId}`) === 'true';
            localStorage.setItem(`comment_liked_${commentId}`, !isLiked);
            
            // Update UI
            const btn = document.querySelector(`.comment-item[data-id="${commentId}"] .comment-action-btn`);
            if (btn) {
                btn.classList.toggle('liked');
                const countSpan = btn.querySelector('span');
                if (countSpan) {
                    const currentCount = parseInt(countSpan.textContent) || 0;
                    countSpan.textContent = isLiked ? Math.max(0, currentCount - 1) : currentCount + 1;
                }
            }
        }
        
        // Reply to comment
        function replyToComment(commentId, author) {
            const input = document.getElementById('commentInput');
            if (input) {
                input.value = `@${author} `;
                input.focus();
                document.getElementById('commentActions').style.display = 'flex';
            }
        }
        
        // Helper: Format time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
                }
            }
            return 'Just now';
        }
        
        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper: Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? 'var(--primary-color)' : type === 'error' ? '#FF6B6B' : 'var(--background-light)'};
                color: ${type === 'success' ? '#000' : '#fff'};
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Save watch progress to localStorage for Continue Watching feature
        function saveWatchProgress(currentTime, duration) {
            if (!movieId || !duration) return;
            
            const percentage = (currentTime / duration) * 100;
            const watchProgress = JSON.parse(localStorage.getItem('watchProgress') || '{}');
            
            watchProgress[movieId] = {
                currentTime: currentTime,
                duration: duration,
                percentage: percentage,
                lastWatched: new Date().toISOString(),
                title: document.getElementById('movieTitle')?.textContent || 'Unknown',
                poster: document.getElementById('moviePoster')?.src || ''
            };
            
            localStorage.setItem('watchProgress', JSON.stringify(watchProgress));
        }
        
        // Track video progress for Continue Watching
        if (video) {
            video.addEventListener('timeupdate', () => {
                if (video.duration && video.currentTime) {
                    saveWatchProgress(video.currentTime, video.duration);
                }
            });
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed'));
            });
        }
    </script>
    
    <!-- System Notification -->
    <script src="js/system-notification.js"></script>
</body>
</html>
